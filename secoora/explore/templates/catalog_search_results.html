{% extends 'base_with_sidebar.html' %}
{% block main %}
{% load flatblock_tags %}

<div class="row-fluid">
  <div class="span4 pull-right">
    <b>Search for {{ catalog_q }} found {{ result_count }} results</b>
  </div>
</div>
<div class="row-fluid">
  <div class="span8 theme catalog-page accordion" id="theme-list">
    {% for layer in layers %}

    <div class="accordion-group theme-group">
        <div class="accordion-heading theme-heading">
            <a class="accordion-toggle theme-title color-up" data-toggle="collapse" data-parent="theme-list" href="#{{ theme_dict.theme.name }}">
                <h3>
                    <span class="theme-search-name">{{ layer.name }}</span>
                    <small><i class="icon-caret-right caret-icon color-up" style="display: inline-block"></i></small>
                    <small><i class="icon-caret-down caret-icon color-up" style="display: none"></i></small>
                </h3>
            </a>
        </div>
    </div>
    {% endfor layers%}
  </div>
</div>

<style type="text/css">

input[type="text"] {
    /*border: 0px;*/
}
input[type="text"]:hover {
    /*border: 1px solid #cccccc;*/
}

.catalog-search-button {
    background-color: transparent;
    border: 0;
    padding: 0;
}

#theme-list .accordion-group {
    border: 0px;
    margin-bottom: 0px;
}

#theme-list .theme-group {
    padding-bottom: 3px;
    border-bottom: 1px solid #e5e5e5;
    width: 95%;
}

#theme-list .accordion-heading {
    display: table;
}

#theme-list .accordion-toggle {
    display: table-cell;
    vertical-align: middle;
    padding: 0px 15px;
    height: 41px;
}

#theme-list .accordion-inner li {
    padding-left: 0px;
    padding-right: 16px;
}

#theme-list .accordion-body {
    position: static;
}

#theme-list h3 {
    margin: 0px;
}

#theme-list a {
    text-decoration: none;
}

#theme-list .theme-heading .color-up h3 {
    color: rgba(3, 11, 212, 1);
}

#theme-list .theme-heading .color-down h3 {
    color: rgba(3, 11, 212, .5);
}

#theme-list .theme-heading small {
    vertical-align: middle;
}

#theme-list .theme-heading i.color-up {
    color: rgba(0,0,0, 1);
}

#theme-list .theme-heading i.color-down {
    color: rgba(0,0,0, .5);
}

#theme-list .layer-heading .color-up {
    color: rgba(102, 102, 102, 1);
}
#theme-list .layer-heading .color-down {
    color: rgba(102, 102, 102, .5);
}

#theme-list .sublayer-heading .color-up {
    color: rgba(102, 102, 102, 1);
}
#theme-list .sublayer-heading .color-down {
    color: rgba(102, 102, 102, .5);
}

#theme-list .data-layer-links .color-up {
    color: rgba(3, 11, 212, 1);
}

#theme-list .data-layer-links .color-down {
    color: rgba(3, 11, 212, .8);
}

#theme-list .data-layer-links li  {
    display: inline-block;
}

.blog .typeahead {
    width: 28%;
}

.blog .typeahead li a {
    overflow: hidden;
    text-overflow: ellipsis;
}

</style>

{% endblock %}


{% block javascript %}
<script>
    $(document).ready( function() {
        var layers = [],
            layer_index = {},

            search =  function(val) {
                var layer = layer_index[val];

                //layer.layer.closest('tr').effect("pulsate", {times:2 }, 500);
                if ( ! $(layer.layer).closest('.theme-group').find('.accordion-body').first().hasClass('in') ) {
                    $(layer.layer).closest('.theme-group').find('.accordion-body').first().collapse('show');
                }
                if ( ! $(layer.layer).closest('.layer-group').find('.accordion-body').first().hasClass('in') ) {
                    $(layer.layer).closest('.layer-group').find('.accordion-body').first().collapse('show');
                }
                if ( $(layer.layer).closest('.sublayer-group').find('.accordion-body').first().length ) {
                    $(layer.layer).closest('.sublayer-group').find('.accordion-body').first().collapse('show');
                    $(layer.layer).closest('.sublayer-group').find('.layer-search-name').effect("pulsate", {times:1}, 500);
                } else {
                    $(layer.layer).closest('.layer-group').find('.layer-search-name').first().effect("pulsate", {times:1}, 500);
                }
                setTimeout(function() {$(window).scrollTop(layer.layer.closest('.layer-group').offset().top-300)}, 200);
            };

        if (window.location.hash) {
          //To get the nested accordions to open up from the Learn page(or anything else that uses an anchor) we've got to get the
          //parent elements of the desired layer, then force them open starting from the top down.The parentsUntil function returns all the
          //parent elements of the one we are interested in up until it finds the one with a class of theme-group. theme-group is the top
          //most containing element, for us it represents the layer grouping, such as Juridictions and Boundaries.
          var parentDivs = $(window.location.hash).parentsUntil('[class~="theme-group"]');
          for(var ndx = parentDivs.length - 1; ndx >= 0; ndx--)
          {
            if($(parentDivs[ndx]).hasClass('collapse'))
            {
              $(parentDivs[ndx]).collapse('show');
            }
          }
          //This opens info/link for the layer we are interested in.
          $(window.location.hash).collapse('show');
          $(window).scrollTop($(window).scrollTop() - 100);
          $(window.location.hash).closest('tr').effect("pulsate", {times:2 }, 500);

        }

        $('.theme-group').each( function(index, theme) {
            var theme_name = $(theme).find('.theme-search-name').text();
            $(theme).find('.layer-search-name').each( function(index, layer) {
                var name = $.trim($(layer).text()) + ' (' + $.trim(theme_name) + ')',
                    description = $(layer).closest('.accordion-group').find('.descriptive-text'),
                    kitchenSink = $.trim($(layer).text()) + ' ' + $.trim(theme_name) + ' ' + $.trim($(description).text());
                layers.push(name);
                layer_index[name] = {
                    layer: $(layer),
                    fullSearch: kitchenSink
                };
            });
        });

        $('.layer-search').find('input').typeahead( {
            source: layers.sort(),
            matcher: function(item) {
                if (layer_index[item].fullSearch.toLowerCase().indexOf(this.query.toLowerCase()) !== -1) {
                    return true;
                }
            }
        });

        $('.layer-search').submit(function (event) {
            event.preventDefault();
            //console.log('layer-search submit');
            search($(this).find('input').val());
        });


        $('.layer-search').on('keyup', 'input', function (event) {
            event.preventDefault();
            //console.log('layer-search keyup ' + event.which);
            if (event.which === 13) {
                search($(this).val());
            }
        });

        $('ul.typeahead').on('click', 'li', function () {
        //$('.layer-search').on('click', 'li', function () {
            //console.log('layer-search list click');
            search($(this).text());
        });

        $('.theme-name').on('hover', function() {
            var span = $(this),
                name = span.data('name'),
                thumbnail = span.data('thumbnail'),
                theme = span.closest('.theme');
            //theme.find('.title').text(name);
            if ( thumbnail === 'None' || thumbnail === '') {
                thumbnail = 'http://placehold.it/320x180';
            }
            //theme.find('.thumbnail img').attr('src', thumbnail);
        });
        $('.layer-name').on('hover', function() {
            var layer = $(this),
                name = layer.data('name'),
                thumbnail = layer.data('thumbnail'),
                theme = layer.closest('.theme');
            //theme.find('.title').text(name);
            if ( thumbnail === 'None' || thumbnail === '') {
                thumbnail = 'http://placehold.it/320x180';
            }
            //theme.find('.thumbnail img').attr('src', thumbnail);
        });
        //overriding the template here to remove empty space for title
        $('.layer-name').popover({
            template: '<div class="popover layer-popover"><div class="arrow"></div><div class="popover-inner layer-tooltip"><div class="popover-content"><p></p></div></div></div>'
        });

        // MODIFIED DATA CATALOG

        $('.theme-group').hover(function(e) { //trigger the mouseover event
            $('.theme-title').removeClass('color-up');
            $('.theme-title').addClass('color-down');
            $('.caret-icon').removeClass('color-up');
            $('.caret-icon').addClass('color-down');
            $(e.currentTarget).find('.theme-title').removeClass('color-down');
            $(e.currentTarget).find('.theme-title').addClass('color-up');
            $(e.currentTarget).find('.caret-icon').removeClass('color-down');
            $(e.currentTarget).find('.caret-icon').addClass('color-up');
            $('#theme-list .in').siblings('.theme-heading').find('.theme-title').removeClass('color-down');
            $('#theme-list .in').siblings('.theme-heading').find('.theme-title').addClass('color-up');
            $('#theme-list .in').siblings('.theme-heading').find('.caret-icon').removeClass('color-down');
            $('#theme-list .in').siblings('.theme-heading').find('.caret-icon').addClass('color-up');
        }, function(e) { //trigger the mouseout event
            $('.theme-title').removeClass('color-down');
            $('.theme-title').removeClass('color-up');
            $('.theme-title').addClass('color-up');
            $('.caret-icon').removeClass('color-down');
            $('.caret-icon').removeClass('color-up');
            $('.caret-icon').addClass('color-up');
        });

        $('.theme-accordion').on('show', function(e) {
            $(e.currentTarget).siblings('.theme-heading').find('i.icon-caret-right').css('display', 'none');
            $(e.currentTarget).siblings('.theme-heading').find('i.icon-caret-down').css('display', 'inline-block');
        });

        $('.theme-accordion').on('hide', function(e) {
            $(e.currentTarget).siblings('.theme-heading').find('i.icon-caret-right').css('display', 'inline-block');
            $(e.currentTarget).siblings('.theme-heading').find('i.icon-caret-down').css('display', 'none');
        });

        $('.layer-group').hover(function(e) { //trigger the mouseover event
            $('.layer-namee').removeClass('color-up');
            $('.layer-name').addClass('color-down');
            $(e.currentTarget).find('.layer-name').removeClass('color-down');
            $(e.currentTarget).find('.layer-name').addClass('color-up');
            $('#theme-list .in').siblings('.layer-heading').find('.layer-name').removeClass('color-down');
            $('#theme-list .in').siblings('.layer-heading').find('.layer-name').addClass('color-up');
        }, function(e) { //trigger the mouseout event
            $('.layer-name').removeClass('color-down');
            $('.layer-name').removeClass('color-up');
            $('.layer-name').addClass('color-up');
        });

        $('.sublayer-name').hover(function(e) { //trigger the mouseover event
            $('.sublayer-namee').removeClass('color-up');
            $('.sublayer-name').addClass('color-down');
            $(e.currentTarget).removeClass('color-down');
            $(e.currentTarget).addClass('color-up');
            $('#theme-list .in').siblings('.sublayer-heading').find('.sublayer-name').removeClass('color-down');
            $('#theme-list .in').siblings('.sublayer-heading').find('.sublayer-name').addClass('color-up');
        }, function(e) { //trigger the mouseout event
            $('.sublayer-name').removeClass('color-down');
            $('.sublayer-name').removeClass('color-up');
            $('.sublayer-name').addClass('color-up');
        });

        $('.data-layer-link').hover(function(e) { //trigger the mouseover event
            $('.data-layer-link').removeClass('color-up');
            $('.data-layer-link').addClass('color-down');
            $(e.currentTarget).removeClass('color-down');
            $(e.currentTarget).addClass('color-up');
            //$('#theme-list .in').siblings('.sublayer-heading').find('.sublayer-name').removeClass('color-down');
            //$('#theme-list .in').siblings('.sublayer-heading').find('.sublayer-name').addClass('color-up');
        }, function(e) { //trigger the mouseout event
            $('.data-layer-link').removeClass('color-down');
            $('.data-layer-link').removeClass('color-up');
            $('.data-layer-link').addClass('color-up');
        });

    });
</script>
{% endblock %}
