<!DOCTYPE html>
{% load url from future %}
<html lang="en">
    
    <head>
        <meta charset="utf-8">
        <title>
            MARCO Planning Tool
        </title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="description" content="">
        <meta name="author" content="">
        <!-- Le styles -->
        <link href="{{MEDIA_URL}}/marco/css/bootstrap.css" rel="stylesheet">
        <link href="{{MEDIA_URL}}/marco/css/marco_style.css" rel="stylesheet">
        <link href="{{MEDIA_URL}}/marco-proto/assets/css/scalebar-thin.css" rel="stylesheet">
        <link href="{{MEDIA_URL}}/marco-proto/assets/css/style.css" rel="stylesheet">
        <link href="{{MEDIA_URL}}/marco-proto/assets/css/pageguide.css" rel="stylesheet">

        <link href="{{MEDIA_URL}}/marco/css/smoothness/jquery-ui-1.9.1.custom.css" rel="stylesheet">
        <link href="{{MEDIA_URL}}/marco-proto/assets/css/jquery.mCustomScrollbar.css" rel="stylesheet">
        <link href="{{MEDIA_URL}}marco/css/jquery.jscrollpane.css" rel="stylesheet">
        <!--<link href="{{MEDIA_URL}}/marco-proto/assets/css/jScrollPane.css" rel="stylesheet">-->
        <!--<link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.21/themes/base/jquery-ui.css"
        type="text/css" media="all" />-->
        <link rel="shortcut icon" href="{{MEDIA_URL}}marco/ico/favicon.ico">

        <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
        <!--[if lt IE 9]>
            <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
            <link href="{{MEDIA_URL}}/marco/css/marco_style.ie.css" rel="stylesheet">
            <style>
                    #feedback-tab {
                        -ms-filter: "progid:DXImageTransform.Microsoft.Matrix(M11=-1.836909530733566e-16, M12=-1, M21=1, M22=-1.836909530733566e-16, SizingMethod='auto expand')";
                        left: 0px;

                        /* IE6 and 7 */ 
                        filter: progid:DXImageTransform.Microsoft.Matrix(
                                 M11=-1.836909530733566e-16,
                                 M12=-1,
                                 M21=1,
                                 M22=-1.836909530733566e-16,
                                 SizingMethod='auto expand');

                      }
            </style>
            <script src="{{MEDIA_URL}}marco/js/respond.min.js"></script>
        <![endif]-->
        <!-- Le fav and touch icons -->
        <!--[if IE 7]>
          <link rel="stylesheet" href="{{MEDIA_URL}}marco/css/font-awesome-ie7.css">
        <![endif]-->

        <style>
        .navbar .nav > li:hover > a, .navbar .nav > li.active > a, .navbar .nav > li:hover > a:visited {
            height: 30px;
           
        }
        .navbar .nav > li > a {
            height: 25px;
        }

        </style>
        <link rel="apple-touch-icon-precomposed" sizes="144x144" href="{{MEDIA_URL}}/marco-proto/assets/ico/apple-touch-icon-144-precomposed.png">
        <link rel="apple-touch-icon-precomposed" sizes="114x114" href="{{MEDIA_URL}}/marco-proto/assets/ico/apple-touch-icon-114-precomposed.png">
        <link rel="apple-touch-icon-precomposed" sizes="72x72" href="{{MEDIA_URL}}/marco-proto/assets/ico/apple-touch-icon-72-precomposed.png">
        <link rel="apple-touch-icon-precomposed" href="{{MEDIA_URL}}/marco-proto/assets/ico/apple-touch-icon-57-precomposed.png">
        
        <!-- Google Analytics -->
        <script type="text/javascript">

          var _gaq = _gaq || [];
          _gaq.push(['_setAccount', 'UA-35841423-1']);
          _gaq.push(['_trackPageview']);

          (function() {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
          })();

        </script>
        
        
    </head>
    
    <body>
    
        
        <!-- modals -->
        {% include "modals.html" %}
        <!-- end modals -->

        <!-- TOUR -->
        {% include "tour.html" %}
        <!-- END TOURS -->
        
        <!-- REGISTRATION MODALS -->
        <!--
        <div id="thankyou-modal" class="modal hide fade">
            <form class="form-horizontal" id="thankyou-form">
        -->
        <!-- SIGN IN MODAL -->
        <div id="sign-in-modal" class="modal hide fade">
            <!--<form class="form-horizontal" id="sign-in-form" action="/accounts/signin/" method="post">{% csrf_token %}-->
            <form id="sign-in-form" class="form-horizontal" action="/accounts/signin/" method="post" data-bind="submit: verifyLogin">{% csrf_token %}
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h3>Sign In</h3>
                </div>
                <div class="modal-body"> 
                    <div class="control-group">
                      <label class="control-label" for="username">Username</label>
                      <div class="controls">
                        <input id="login-username" class="input-xlarge" type="text" name="username" placeholder="username" data-bind="event: { blur: verifyLogin, focus: turnOffInactiveError }" required>
                        <span class="help-inline" data-bind="visible: inactiveError" style="margin-left: -160px;">
                            <div>The username you entered belongs to an account that has not yet been activated.</div>  
                            <div>If you requested this username, you should have received an email with a link that activates this account.</div>
                            <div>If you are having trouble activating your account, <a href="" data-dismiss="modal" data-toggle="modal" data-target="#feedback-modal">please let us know</a>.</div>
                        </span>
                      </div>
                    </div>
                    <div class="control-group">
                      <label class="control-label" for="password1">Password</label>
                      <div class="controls">
                          <input id="login-password" class="input-xlarge empty-input" placeholder="Password" type="password" name="password" required>
                          <span class="help-inline" data-bind="visible: passwordError"><div>The login information you entered is incorrect.</div>  <div>Please try again.</div></span>
                      </div>
                    </div>
                    <div>
                        <input type="hidden" name="next" data-bind="attr: { value: currentURL() }">
                    </div>
                    <div> 
                        <p><a href="#registration-modal" data-dismiss="modal" data-toggle="modal">Not yet Registered?</a></p>
                    </div>
                    <div>
                        <p><a href="#forgot-username-modal" data-dismiss="modal" data-toggle="modal">Forgot your username?</a></p>
                    </div>
                    <div>
                        <p><a href="#forgot-password-modal" data-dismiss="modal" data-toggle="modal">Forgot your password?</a></p>
                    </div>
                </div>
                <div class="modal-footer">
                    <input type="button" href="#" class="btn" data-dismiss="modal" value="Close">
                    <input type="submit" class="btn btn-primary" value="Sign In">
                </div>
          </form>
        </div>
        
        <!-- FORGOT USERNAME -->
        <div id="forgot-username-modal" class="modal hide fade">
            <form class="form-horizontal" id="forgot-username-form" action="/marco_profile/forgot_username/" method="post">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h3>Forgotten Username</h3>
                </div>
                <div class="modal-body"> 
                    <div> 
                        <p>Enter your email address below and we will send you an email containing your username.</p>
                    </div>
                    <div class="control-group">
                      <label class="control-label" for="email">Email</label>
                      <div class="controls">
                        <input class="input-xlarge" type="text" name="email" placeholder="Email" required>
                      </div>
                    </div>
                    <div>
                        <input type="hidden" name="next" data-bind="attr: { value: currentURL() }">
                    </div>
                </div>
                <div class="modal-footer">
                    <input type="button" href="#" class="btn" data-dismiss="modal" value="Close">
                    <input type="submit" class="btn btn-primary" value="Submit">
                </div>
          </form>
        </div>        
        
        <!-- FORGOT PASSWORD -->
        <div id="forgot-password-modal" class="modal hide fade">
            <!--<form class="form-horizontal" id="forgot-password-form" action="/marco_profile/change_password/{{user.username}}/" method="post">{% csrf_token %}-->
            <form class="form-horizontal" id="forgot-password-form" action="/marco_profile/password/reset/" method="post">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h3>Password Change</h3>
                </div>
                <div class="modal-body"> 
                    <div class="control-group">
                      <label class="control-label" for="email">Email</label>
                      <div class="controls">
                        <input class="input-xlarge" type="text" name="email" placeholder="Email" required>
                      </div>
                    </div>
                    <div>
                        <input type="hidden" name="next" data-bind="attr: { value: currentURL() }">
                    </div>                    
                </div>
                <div class="modal-footer">
                    <input type="button" href="#" class="btn" data-dismiss="modal" value="Close">
                    <input type="submit" class="btn btn-primary" value="Submit">
                </div>
          </form>
        </div>
        
        <!-- REGISTRATION MODAL -->
        <div id="registration-modal" class="modal hide fade">
            <form class="form-horizontal" id="registration-form" action="{% url 'marco_registration_register' %}" method="post">{% csrf_token %}
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h3>Register</h3>
                </div>
                <div class="modal-body">        
                    <div class="control-group">
                      <label class="control-label" for="first-name">First Name</label>
                      <div class="controls">
                        <input class="input-xlarge" type="text" name="first_name" placeholder="First Name" required>
                      </div>
                    </div>       
                    <div class="control-group">
                      <label class="control-label" for="last-name">Last Name</label>
                      <div class="controls">
                        <input class="input-xlarge" type="text" name="last_name" placeholder="Last Name" required>
                      </div>
                    </div>       
                    <div class="control-group" data-bind="css: { error: usernameError }">
                      <label class="control-label" for="username">Username</label>
                      <div class="controls">
                        <input class="input-xlarge" type="text" data-bind="value: username, event: { blur: checkUsername, focus: turnOffUsernameError }" name="username" placeholder="username" required>
                        <span class="help-inline" data-bind="visible: usernameError">That username is already in use.  Please try another username.</span>
                      </div>
                    </div>
                    <div class="control-group">
                      <label class="control-label" for="email">Email Address</label>
                      <div class="controls">
                        <input class="input-xlarge empty-input" type="email" name="email" placeholder="Email Address" required>
                      </div>
                    </div>
                    <div class="control-group">
                      <label class="control-label" for="password1">Password</label>
                      <div class="controls">
                          <input class="input-xlarge empty-input" type="password" placeholder="Password" data-bind="value: password1, valueUpdate: 'afterkeydown', event: { keyup: checkPassword }" name="password1" required>
                      </div>
                    </div>
                    <div class="control-group" data-bind="css: { warning: passwordWarning, success: passwordSuccess }">
                      <label class="control-label" for="password2">Password (re-enter)</label>
                      <div class="controls">
                          <input class="input-xlarge empty-input" type="password" placeholder="Password" data-bind="value: password2, valueUpdate: 'afterkeydown', event: { keyup: checkPassword }" name="password2" required>
                          <span class="help-inline" data-bind="visible: passwordWarning()">Passwords do not match</span>
                          <span class="help-inline" data-bind="visible: passwordSuccess()">Success!</span>
                      </div>
                    </div>
                    <div>
                        <input type="hidden" name="next" data-bind="attr: { value: currentURL() }">
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="pull-right">
                        <input type="button" class="btn" data-dismiss="modal" value="Close">
                        <input type="submit" class="btn btn-primary" value="Register">
                    </div>
                </div>
          </form>
        </div>
        
        <!-- RESET PASSWORD -->
        <div id="reset-password-modal" class="modal hide fade">
            <!--<form class="form-horizontal" id="forgot-password-form" action="/marco_profile/change_password/{{user.username}}/" method="post">{% csrf_token %}-->
            <form class="form-horizontal" id="reset-password-form" action="/marco_profile/password_change/{{user.username}}/" method="post" data-bind="submit: verifyPassword">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h3>Password Change</h3>
                </div>
                <div class="modal-body"> 
                    <div>
                        <input type="hidden" name="username" value="{{user.username}}">
                    </div>
                    <div class="control-group">
                      <label class="control-label" for="old_password">Old Password</label>
                      <div class="controls">
                          <input class="input-xlarge empty-input" placeholder="Current Password" type="password" name="old_password" required>
                          <span class="help-inline" data-bind="visible: passwordError"><div>The password you entered is incorrect.</div>  <div>Please enter your original password again.</div></span>
                      </div>
                    </div>
                    <div class="control-group">
                      <label class="control-label" for="password1">New Password</label>
                      <div class="controls">
                          <input class="input-xlarge" type="password" placeholder="New Password" name="new_password1" data-bind="value: password1" required>
                      </div>
                    </div>
                    <div class="control-group" data-bind="css: { warning: passwordWarning, success: passwordSuccess }">
                      <label class="control-label" for="password2">Confirm Password</label>
                      <div class="controls">
                          <input class="input-xlarge empty-input" type="password" placeholder="New Password" data-bind="value: password2, valueUpdate: 'afterkeydown', event: { keyup: checkPassword }" name="new_password2" required>
                          <span class="help-inline" data-bind="visible: passwordWarning()">Passwords do not match</span>
                          <span class="help-inline" data-bind="visible: passwordSuccess()">Success!</span>
                      </div>
                    </div>
                    <div>
                        <input type="hidden" name="next" data-bind="attr: { value: currentURL() }">
                    </div>
                </div>
                <div class="modal-footer">
                    <input type="button" href="#" class="btn" data-dismiss="modal" value="Close">
                    <input type="submit" class="btn btn-primary" value="Update Password">
                </div>
          </form>
        </div>
                
        <!-- PROFILE MODAL -->
        <div id="profile-modal" class="modal hide fade">
            <form class="form-horizontal" id="profile-form" action="/marco_profile/update_profile/{{user.username}}/" method="post">{% csrf_token %}
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h3>{{user.username}}</h3>
                </div>
                <div class="modal-body">        
                    <div class="control-group">
                      <label class="control-label" for="first-name">First Name</label>
                      <div class="controls">
                        <input class="input-xlarge" type="text" name="first_name" value="{{user.first_name}}">
                      </div>
                    </div>       
                    <div class="control-group">
                      <label class="control-label" for="last-name">Last Name</label>
                      <div class="controls">
                        <input class="input-xlarge" type="text" name="last_name" value="{{user.last_name}}">
                      </div>
                    </div>
                    <div class="control-group">
                      <label class="control-label" for="email">Email Address</label>
                      <div class="controls">
                        <input class="input-xlarge" type="email" name="email" value="{{user.email}}" required>
                      </div>
                    </div>
                    <div>
                        <input type="hidden" name="next" data-bind="attr: { value: currentURL() }">
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="pull-right">
                        <input type="button" class="btn" data-dismiss="modal" value="Close">
                        <input type="submit" class="btn btn-primary" value="Update Profile">
                    </div>
                </div>
          </form>
        </div>
        
        <!-- END REGISTRATION MODALS -->
        
        <header role="banner">
            <div class="navbar navbar-fixed-top">
                <div class="navbar-inner">
                    <div class="container-fluid">
                        <div class="row-fluid">
                            <div class="span5">
                                <a href="/portal">
                                    <img src="{{MEDIA_URL}}marco/img/marco-logo_planner.jpg"/>
                                </a>
                                <h3 class="pull-right" data-bind="visible: mapTitle, text: mapTitle"></h3>
                            </div>
                            <div class="span7">
                                <div class="pull-right">
                                    <!--<li class=""><a href="/portal">Return to Portal</a></li>-->
                                    <!--<li class=""><a href="">Help</a></li>-->
                                    <span class="user-btn">
                                        <a id="help-button" class="btn" href="#help-modal" data-toggle="modal">Help</a>
                                      
                                        {% if user.is_authenticated %}
                                        <span class="btn-group">
                                          <a class="btn dropdown-toggle" data-toggle="dropdown" href="#">
                                            <i class="icon-user"></i> 
                                            {{user.username}}
                                            <span class="caret"></span>
                                          </a>
                                          <ul id="username" class="dropdown-menu">
                                            <li><a href="#profile-modal" data-toggle="modal"><i class="icon-pencil"></i> Profile</a></li>
                                            <li><a href="#reset-password-modal" data-toggle="modal"><i class="icon-lock"></i> Password</a></li>
                                            <li class="divider"></li>
                                            <li><a href="{% url 'user_signout' %}"><i class="i"></i>Log Out</a></li>
                                          </ul>
                                        </span>
                                        {% else %}
                                        <a id="#sign-in-button" class="btn" href="#sign-in-modal" data-toggle="modal">Sign In / Register</a>                            
                                        {% endif %}
                                    </span>
                                </div>
                            </div><!--/.nav-collapse -->
                        </div>
                    </div>
                </div>
            </div>
        </header> <!-- end header -->
        
        <div class="container-fluid" id="primary-content">
            <div id="loading">
                <h2>Loading...</h2>
            </div>
            <div class="row-fluid" id="fullscreen">
                
                <!-- Data Panel (left panel) -->
                <div class="span4 frame tabs" data-bind="visible: showLayers(), css: {'fullscreen-data': isFullScreen()}">
                    <div class="sidebar-nav">
                        <!-- tab controls -->
                        <ul id="myTab" class="nav nav-tabs">
                            <li class="active" data-tab="data">
                                <a href="#data" data-toggle="tab" id="dataTab">Data</a>
                            </li>
                            {% load in_group %}
                            {% if user.is_authenticated and user|in_group:"Designers" %}
                            <li  data-tab="designs" >
                                <a href="#designs" data-toggle="tab" id="designsTab">Designs</a>
                            </li>
                            {% endif %}
                            <li  data-tab="active" >
                                <a href="#active" data-toggle="tab" id="activeTab">Active  
                                    <span data-bind="visible: activeLayers().length > 0">
                                        (<span  data-bind="text: activeLayers().length">0</span>)
                                    </span>
                                </a>
                            </li>
                            
                        </ul>
                        <!-- tab body -->
                        <div id="myTabContent" class="tab-content">
                        
                            <!-- DATA TAB -->
                            <div class="tab-pane active in fade" id="data">
                                <div class="row-fluid">
                                    <div class="span12 ">
                                        <form class="form-search" data-bind="submit: layerSearch">
                                            <div class="span12">
                                                <input type="text" class="search-box" data-provide="typeahead" data-bind="value: searchTerm, event: { keyup: keySearch }" style="overflow: hidden; text-overflow: ellipsis;" placeholder="find layers">
                                                
                                                <a class="btn">
                                                    <i class="icon-remove icon-large"></i> 
                                                </a>
                                            </div>
                                        </form>
                                    </div>
                                    <div class="row-fluid" style="margin-top: 20px">
                                        <div class="span12 accordion-wrapper">
                                            <!-- data accordion -->
                                            <div id="data-accordion">
                                                <div class="accordion" data-bind="foreach: themes">
                                                    <div class="accordion-group">
                                                        <div class="accordion-heading" data-bind="click: setOpenTheme, css: { 'active': isOpenTheme() }">
                                                            <div>
                                                                <a class="accordion-toggle"> <!--event: {'hover': showDescription}-->
                                                                    <span data-bind="text: name">Themes</span></a>
                                                            </div>
                                                        </div>
                                                        <div class="accordion-body collapse" data-bind="css: { 'in': isOpenTheme() }">
                                                            <div class="accordion-inner">
                                                                <ul  class="unstyled" data-bind="foreach: layers ">
                                                                    <li class="layer" data-bind="css: { nosublayers: subLayers.length === 0 }">
                                                                        <div class="btn-group btn-group-layer" data-bind="css: {'open': showSublayers() }, attr: {name: name}">
                                                                            <a class="btn btn-info-sign" data-bind="click: toggleDescription, css: { 'active': infoActive() }">
                                                                                <i class="icon-info-sign icon-large"></i>
                                                                            </a>

                                                                            <a class="btn btn-layer" data-bind="css: { 'active': active(), 'not-active': ! active() }, click: toggleActive">
                                                                                <div style="font-weight: normal">
                                                                                    <!--<span data-bind="visible: ! activeSublayer() || isCheckBoxLayer()">
                                                                                        <span data-bind="text: name"></span>
                                                                                    </span>
                                                                                    <span data-bind="visible: activeSublayer && ! isCheckBoxLayer()">
                                                                                        <span data-bind="text: activeSublayer().name"></span>
                                                                                    </span>-->
                                                                                    <span data-bind="text: name"></span>
                                                                                    <span class="caret" style="display:none" data-bind="visible: subLayers.length > 0"></span>
                                                                                    <i class="check icon-large icon-check" data-bind="visible: active() && visible()"></i>
                                                                                    <i class="check icon-large icon-check-empty" data-bind="visible: active() && ! visible()"></i>
                                                                                </div>
                                                                            </a>

                                                                            <!-- ko if: subLayers.length > 0 -->
                                                                            <!-- ko if: !isCheckBoxLayer() -->
                                                                            <ul class="dropdown-menu layer-menu" data-bind="event: { mouseleave: closeMenu }">
                                                                                <li data-bind="foreach: subLayers">
                                                                                    <a data-bind="click: toggleActive">
                                                                                        <span data-bind="style: {visibility: active() ? 'visible': 'hidden' }">• </span>
                                                                                        <!--<span style="margin-left: -10px" data-bind="style: {visibility: active() ? 'visible': 'hidden' }">
                                                                                            <i class="icon-ok-circle"></i>
                                                                                        </span>-->
                                                                                        <span data-bind="text: name"></span>
                                                                                    </a>
                                                                                </li>
                                                                            </ul>
                                                                            <!-- /ko -->
                                                                            <!-- ko if: isCheckBoxLayer() -->
                                                                            <ul class="dropdown-menu layer-menu" data-bind="event: { mouseleave: closeMenu }">
                                                                                <li data-bind="foreach: subLayers">
                                                                                    <a data-bind="click: toggleActive">
                                                                                        <span style="margin-left: -10px">
                                                                                            <i class="icon-check" data-bind="style: {display: active() ? 'inline': 'none' }"></i>
                                                                                            <i style="opacity: .4" class="icon-check-empty" data-bind="style: {display: ! active() ? 'inline': 'none' }"></i>
                                                                                        </span>
                                                                                        <span data-bind="text: name"></span>
                                                                                    </a>
                                                                                </li>
                                                                            </ul>
                                                                            <!-- /ko -->
                                                                            <!-- /ko -->
                                                                        </div>
                                                                    </li>  
                                                                </ul>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <!-- /data-accordion -->
                                        </div>
                                    </div>
                                    <!-- /span -->
                                </div>
                                <!-- /row -->
                            </div>
                            <!-- END DATA TAB -->
                            
                            <!-- DESIGNS TAB -->
                            {% if user.is_authenticated and user|in_group:"Designers" %}
                            {% include "scenarios.html" %}
                            {% endif %}
                            <!-- END DESIGNS TAB -->
                            
                            <!-- ACTIVE TAB -->
                            <div class="tab-pane fade" id="active">
                                <div class="row-fluid">
                                    <div class="span12">
                                        <div data-bind="visible: activeLayers().length === 0">
                                            <div style="padding: 10px;">
                                                <p>
                                                    You currently have no activated data layers. 
                                                </p>
                                                <p>
                                                    Any layers that are activated in the Data panel will appear in this Active panel.
                                                </p>
                                                <p>
                                                    Layers in the Active panel can be adjusted in terms of their transparency and their ordering on the map.
                                                </p>
                                            </div>
                                        </div>
                                        <ul class="unstyled list" data-bind="sortable: { data: activeLayers, options: {  } }">
                                            <li>
                                                <div class="btn-group">
                                                    <button class="btn btn-info-sign" data-bind="click: toggleDescription, css: { 'active': infoActive()}"><i class="icon-info-sign icon-large"></i></button>
                                                    <a class="btn btn-layer" data-bind="css: { 'active': visible() }, click: toggleVisible">
                                                        <div data-bind="text: name"></div>
                                                        <span ><i class="icon-large check" data-bind="css: { 'icon-check': visible(), 'icon-check-empty': ! visible() }"></i></span>
                                                    </a>
                                                    <a class="btn opacity-button" data-bind="click: $parent.showOpacity"><i class="icon-adjust icon-large"></i></a>
                                                    <button class="btn" data-bind="click: toggleActive">
                                                        <i class="icon-remove">
                                                        </i>
                                                    </button>
                                                </div>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <!-- END ACTIVE TAB -->
                        </div>
                    </div>
                </div>
                <!-- /Data Panel -->
                
                <!-- Map Panel (center panel) -->
                <div id="map-panel" data-bind="css: { 'fullscreen-map': isFullScreen() && !showLayers() && !showLegend(), 'fullscreen-with-layers': isFullScreen() && showLayers() && !showLegend(), 'fullscreen-with-legend': isFullScreen() && !showLayers() && showLegend(), 'fullscreen-with-legend-and-layers': isFullScreen() && showLayers() && showLegend(), 'shift-left': ! showLayers(), span12: !showLayers() && !showLegend(), span9: !showLayers() && showLegend(), span8: showLayers() && !showLegend(), span5: showLayers() && showLegend() }">       
                    <div class="row-fluid" data-bind="visible: showMapPanel">
                        <div class="span12">
                            <div class="row-fluid">
                                <div id="map-wrapper">
                                    <div id="map"></div>
                                    <div id="basemaps"> <!-- Basemaps, Legends, Layers, Bookmarks, and FullScreen buttons -->
                                        <div class="btn-group btn-group-vertical">
                                          <!--Basemaps Button-->
                                          <a id="basemap-button" class="btn" data-bind="click: showBasemaps">
                                              <i class="icon-globe icon-large"></i>
                                              <span>Basemaps</span>
                                          </a>
                                          <!--Hide/Show Legends Button-->
                                          <a class="btn" data-bind="click: toggleLegend">
                                              <i class="icon-list-ul icon-large"></i> 
                                              <span data-bind="text: legendButtonText()"></span>
                                              <span data-bind="visible: hasActiveLegends() > 0"> (<span data-bind="text: activeLegendLayers().length"></span>) </span>
                                          </a>
                                          <!--Hide/Show Layers Button-->
                                          <a class="btn" data-bind="click: toggleLayers">
                                              <i class="icon-layers icon-large" data-bind="css: {'icon-indent-right': showLayers(), 'icon-indent-left': ! showLayers()}"></i> 
                                              <span data-bind="text: showLayersText()"></span>
                                          </a>
                                          <!--Bookmarks Button-->
                                          <a id="bookmarks-button" class="btn" data-bind="click: showBookmarks">
                                              <i class="icon-map-marker icon-large"></i>
                                              <span>Bookmarks</span>
                                              <span data-bind="visible: bookmarks.bookmarksList().length > 0">
                                                  (<span data-bind="text: bookmarks.bookmarksList().length"></span>)
                                              </span>
                                          </a>
                                          <!--Fullscreen Button-->
                                          <a class="btn" id="btn-fullscreen">
                                              <i class="icon-fullscreen icon-large"></i>
                                              <span>Fullscreen</span>
                                          </a>
                                          <!-- Print Button -->

                                            <a class="btn" id="btn-print" data-bind="click: printing.showPrintDialog, visible: printing.enabled">
                                                <i class="icon-print icon-large"></i>
                                                <span>Print/Export</span>
                                            </a>
                                        </div>
                                    </div>
                                    <div id="map-buttons">
                                        <!--  
                                        <p><a class="btn pull-right">
                                          Coordinates &amp; Depth
                                        </a></p> 
                                        -->
                                    </div>
                                  
                                    <!-- Attribution Overlay -->
                                    <div id="attribute-data">
                                        <div data-bind="visible: attributeData" style="display: none">
                                          <span class="pull-right"><a href="#" style="margin-left: 10px; opacity: .6;" class="btn btn-mini close" data-bind="click: closeAttribution"> x </a> </span>
                                          <strong><span data-bind="text: attributeTitle()"></span></strong>
                                          <dl data-bind="foreach: attributeData()">
                                            <!--<dt data-bind="text: display"></dt>-->
                                            <!--<dd data-bind="text: data"></dd>-->
                                            <dt>
                                                <span data-bind="text: display"></span><span data-bind="visible: display">:</span>
                                                <span style="font-weight: normal" data-bind="text: data"></span>
                                            </dt>
                                          </dl>
                                        </div>
                                    </div>
                                  
                                    <!-- Bookmark Message -->
                                    <div id="error-overlay" data-bind="visible: error() === 'restoreState'" style="display:none">
                                        <div>
                                            <span class="pull-right">
                                                <a href="#" style="margin-left: 10px; opacity: .6;" class="close btn btn-mini" data-bind="click: closeAlert"> x </a>
                                                <a class="btn btn-mini" data-bind="click: bookmarks.restoreState">
                                                    Return to Previous View
                                                </a>
                                            </span>
                                            "<span data-bind="text: activeBookmark"></span>"
                                            <div class="clearfix"></div>
                                        </div>
                                    </div>
                                  
                                    <!-- FullScreen Fail Message -->
                                    <div id="fullscreen-error-overlay" style="display:none">
                                        <div>
                                            <span class="pull-right">
                                                <a href="#" style="margin-left: 10px; opacity: .6;" class="close btn btn-mini" data-bind="click: closeAlert"> x </a>
                                                
                                            </span>
                                            <span>We're sorry, the Fullscreen option is not supported in all browsers at this time...If it's important, you might try Firefox or Chrome.</span>
                                        </div>
                                    </div>
                                  
                                  <!-- Description Overlay  style="display:none"-->
                                    <div id ="description-overlay" class="row-fluid" style="display: none" data-bind="visible: showDescription() && !showOverview()" >
                                        <div class="span11">
                                            <span class="title" data-bind="text: activeInfoLayer().name"></span> -- 
                                            <span class="text" data-bind="text: activeInfoLayer().description"></span>
                                            <div class="pull-right"><a class="btn btn-mini" data-bind="click: expandDescription, text: 'Show More...'"></a></div>
                                        </div>
                                        <div class="span1">
                                            <a href="#" style="margin-left: 10px; opacity: .6;" class="btn btn-mini pull-right close" data-bind="click: closeDescription"> x </a> 
                                        </div>
                                    </div> 
                                    
                                    <div id="overview-overlay" class="row-fluid" style="display: none" data-bind="visible: showOverview()" >
                                        <div id="overview-overlay-content" class="span12">
                                            <div id="overview-overlay-header" >
                                                <span class="btn-group" data-bind="visible: activeInfoLayer() && activeInfoLayer().subLayers.length !== 0">
                                                    <a id="overview-dropdown-button" class="btn dropdown-toggle" href="#" name="description-dropdown" data-bind="click: activateOverviewDropdown">
                                                        <span data-bind="text: activeInfoSublayer().name ? activeInfoSublayer().name : activeInfoLayer().name"></span>
                                                        <span class="caret"></span>
                                                    </a>
                                                    <ul id="overview-overlay-dropdown" class="dropdown-menu">
                                                        <li>
                                                            <a data-bind="click: activeInfoLayer().toggleSublayerDescription">
                                                                <span data-bind="text: activeInfoLayer().name"></span>
                                                            </a>
                                                        </li>
                                                        <li data-bind="foreach: activeInfoLayer().subLayers">
                                                            <a data-bind="click: toggleSublayerDescription">
                                                                <span data-bind="text: name"></span>
                                                            </a>
                                                        </li>
                                                    </ul>
                                                </span>
                                                <span class="title" data-bind="text: activeInfoLayer().name, visible: activeInfoLayer() && activeInfoLayer().subLayers.length == 0"></span> 
                                                <!--<span class="caret" style="display:none" data-bind="visible: activeInfoLayer().subLayers"></span>-->
                                                <span><a href="#" style="margin-left: 10px; opacity: .8;" class="btn btn-mini pull-right close" data-bind="click: closeDescription"> x </a> </span>
                                            </div>
                                            <div id="overview-overlay-text" style="margin-top: 5px"> 
                                                <span class="text" data-bind="text: getOverviewText()"></span>
                                                <div class="notes">
                                                    <div data-bind="visible: activeInfoSublayer() ? activeInfoSublayer().data_source : activeInfoLayer().data_source">
                                                        Source: 
                                                        <span data-bind="text: activeInfoSublayer() ? activeInfoSublayer().data_source : activeInfoLayer().data_source"></span>
                                                    </div>
                                                    <div style="margin-top: 5px" data-bind="visible: activeInfoSublayer() ? activeInfoSublayer().data_notes : activeInfoLayer().data_notes">
                                                        Notes: 
                                                        <span data-bind="text: activeInfoSublayer() ? activeInfoSublayer().data_notes : activeInfoLayer().data_notes"></span>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            {% load flatblock_tags %}
                                            <div id="overview-overlay-links">
                                              <span class="span11">
                                                <div class="text" style="margin-top: 5px">
                                                    <span>
                                                        <a class="btn btn-mini" data-bind="css: { disabled: ! activeKmlLink() }, attr: { href: activeKmlLink() }" target="_blank">
                                                            <span rel="tooltip" title="{% flatblock 'data_catalog_kml_link_tooltip' %}">
                                                                {% flatblock "data_catalog_kml_link" %}
                                                            </span>
                                                        </a>
                                                    </span>
                                                    <span>
                                                        <a class="btn btn-mini" data-bind="css: { disabled: ! activeDataLink() }, attr: { href: activeDataLink() }" target="_blank">
                                                            <span rel="tooltip" title="{% flatblock 'data_catalog_data_link_tooltip' %}">
                                                                {% flatblock "data_catalog_data_link" %}
                                                            </span>
                                                        </a>
                                                    </span>
                                                    <span>
                                                        <a class="btn btn-mini" data-bind="css: { disabled: ! activeMetadataLink() }, attr: { href: activeMetadataLink() }" target="_blank">
                                                            <span rel="tooltip" title="{% flatblock 'data_catalog_metadata_link_tooltip' %}">
                                                                {% flatblock "data_catalog_metadata_link" %}
                                                            </span>
                                                        </a>
                                                    </span>
                                                    <span>
                                                        <a class="btn btn-mini" data-bind="css: { disabled: ! activeSourceLink() }, attr: { href: activeSourceLink() }" target="_blank">
                                                            <span rel="tooltip" title="{% flatblock 'data_catalog_source_link_tooltip' %}">
                                                                {% flatblock "data_catalog_source_link" %}
                                                            </span>
                                                        </a>
                                                    </span>
                                                </div>
                                              </span>
                                              <span class="span1"></span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                </div>
                            </div>
                        </div>
                    </div>
                </div>    
                
                <!-- Legends Panel (right panel) -->
                <div data-bind="visible: showLegend(), css: {'fullscreen-legend': isFullScreen() }" class="span3" id="legend">
                    <div id="legend-wrapper">
                        <div id="legend-header">
                            <span class="pull-right">
                                <a href="#" style="margin-left: 10px; margin-top: -2px; opacity: .6;" class="btn btn-mini close" data-bind="click: toggleLegend"> x </a> 
                            </span>
                            <span style="text-transform: uppercase;">
                                Legends (<span data-bind="text: activeLegendLayers().length"></span>)
                            </span>
                        </div>
                        <div data-bind="foreach: activeLegendLayers">
                            <div style="padding-bottom: 10px;">
                                <span class="pagination-centered" data-bind="html: legendTitle ? legendTitle : name"></span>
                                <p style="margin: 0px -5px 3px; text-align: left;font-size: 12px;" data-bind="visible: legendSubTitle, html: legendSubTitle"></p>
                                <span data-bind="if: legend">
                                    <div data-bind="css: { 'in': legendVisibility }" style="padding-top: 5px;">
                                        <img data-bind="attr: { src: legend }" />
                                    </div>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- /Legends Panel -->
            </div>
            <span class="timestamp" data-bind="visible: mapTitle"><span data-bind="text: new Date().toString('M/d/yyyy HH:mm')"></span></span>
        </div>

        <!--/row-->
          
        <!--/.fluid-container-->

        

        <!-- transparency tool -->
        <div style="display:none" id="opacity-popover" class="popover fade bottom in">
            <div class="arrow">
            </div>
            <div class="popover-inner">
                <div class="popover-content" data-bind="if: selectedLayer">
                    <div class="slider" data-bind="jqSlider: selectedLayer().opacity, jqOptions: { min: 0, max: 1, step: .01, range: 'min' }"></div>                    
                </div>
            </div>
        </div>
        
        <!--<div style="display:none" id="layer-popover" class="layer-popover popover fade right in" data-bind="event: {'mouseleave': $root.hideTooltip}">
            <div class="arrow"></div>
            <div class="popover-inner layer-tooltip">
                <div class="popover-content">
                    <span data-bind="html: layerToolTipText"></span>
                </div>
            </div>
        </div>-->
        <div style="display:none" id="bookmark-popover" class="popover fade left in" data-bind="with: bookmarks">
            <div class="arrow">
            </div>
            <div class="popover-inner">
                <h3 class="popover-title">
                    Bookmarks
                </h3>
                <div class="popover-content">
                    <p>
                        <div>
                            <div>
                                <div>
                                    <div id="bookmarks-table">
                                        <table class="table table-condensed">
                                            <tbody data-bind="foreach: bookmarksList">
                                                <tr>
                                                    <td>
                                                        <span data-bind="click: $parent.loadBookmark">
                                                        <a data-bind="text: name, attr: {href: $parent.getUrl($data)}">name</a>
                                                        </span>
                                                    </td>
                                                    <td class="tweet-cell">
                                                        <a href="https://twitter.com/share" class="twitter-share-a" data-bind="attr: {'data-url': $parent.getUrl($data)}"
                                                        data-lang="en" data-size="medium" data-count="none">Tweet</a>
                                                        <script>
                                                            ! function(d, s, id) {
                                                                var js, fjs = d.getElementsByTagName(s)[0];
                                                                if (!d.getElementById(id)) {
                                                                    js = d.createElement(s);
                                                                    js.id = id;
                                                                    js.src = "//platform.twitter.com/widgets.js";
                                                                    fjs.parentNode.insertBefore(js, fjs);
                                                                }
                                                            }(document, "script", "twitter-wjs");
                                                        </script>
                                                    </td>
                                                    
                                                 <!--   <td>
                                                        <a class="btn btn-mini tweet-trash" data-bind="click: $parent.prepareEmail" data-toggle="modal" data-target="#bookmark-modal">
                                                            <i class="icon-envelope icon-large"></i>
                                                        </a>
                                                        
                                                    </td>-->
                                                    
                                                    <td>
                                                        <a class="btn btn-mini tweet-trash" data-bind="click: $parent.removeBookmark">
                                                            <i class="icon-trash icon-large">
                                                            </i>
                                                        </a>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                        <p data-bind="visible: bookmarksList().length === 0">
                                            Bookmarks save the map and active layers. You currently have no bookmarks.
                                        </p>
                                    </div>
                                </div>
                                <hr/>
                                <h5>
                                    Create new bookmark
                                </h5>
                                <form data-bind="submit: saveBookmark">
                                    <input type="text" data-bind="value: bookmarkName" class="input">
                                    <div class="pull-right">
                                        <button class="btn btn-mini" type="submit">save</button>
                                        <button data-bind="click: cancel" class="btn btn-mini">cancel</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </p>
                </div>
            </div>
        </div>

        {% include "printing.html" %}

        
        <!-- Le javascript -->
        <!-- Placed at the end of the document so the pages load faster -->
        <!-- <script src="assets/js/bootstrap-transition.js"></script>
    <script src="assets/js/bootstrap-alert.js"></script>
   
    <script src="assets/js/bootstrap-scrollspy.js"></script>
    <script src="assets/js/bootstrap-a.js"></script>
    <script src="assets/js/bootstrap-carousel.js"></script>
    <script src="assets/js/bootstrap-collapse.js"></script>
     -->
        <!--<link rel="stylesheet" type="text/css" href="http://www.transportparadise.co.uk/layerswitcher/layerswitcher.css" />
        <link rel="stylesheet" type="text/css" src="{{MEDIA_URL}}/marco-proto/assets/css/simplelayerswitcher.css" />-->
        <script src="{{MEDIA_URL}}/marco/js/jquery.js"></script>
        <script src="{{MEDIA_URL}}/marco/js/bootstrap.min.js"></script>
        <script src="{{MEDIA_URL}}/marco/js/amplify.min.js"></script>
        <script src="{{MEDIA_URL}}/marco-proto/assets/js/jquery.ba-bbq.js"></script>
        <script src="{{MEDIA_URL}}/marco/js/jquery-ui-1.9.1.custom.js"></script>
        <script src="{{MEDIA_URL}}/marco-proto/assets/js/knockout-2.1.0.js"></script>
        <script src="{{MEDIA_URL}}/marco-proto/assets/js/knockout-bindings.js"></script>
        <script src="{{MEDIA_URL}}/marco-proto/assets/js/knockout.mapping-latest.js"></script>
        <script src="{{MEDIA_URL}}/marco-proto/assets/js/jquery.pageguide.js"></script>
     <!-- <script src="http://maps.google.com/maps/api/js?v=3.5&amp;sensor=false"></script>-->
        <script src="http://maps.google.com/maps/api/js?v=3.6&amp;sensor=false"></script>
        <script src="{{MEDIA_URL}}/marco-proto/assets/openlayers/OpenLayers.js"></script>
        <script src="{{MEDIA_URL}}/marco-proto/assets/js/simplelayerswitcher.js"></script>
        <script src="{{MEDIA_URL}}/marco-proto/assets/js/scalebar.js"></script>
        <script src="{{MEDIA_URL}}/marco/js/bigscreen.js"></script>
        <script src="{{MEDIA_URL}}/marco/js/jquery.ui.touch-punch.min.js"></script>
        <script src="{{MEDIA_URL}}/marco/js/jquery.jscrollpane.min.js"></script>
        <script src="{{MEDIA_URL}}/marco/js/date.js"></script>

        <script src="{{SOCKET_URL}}/socket.io/socket.io.js"></script>
        <!--<script src="http://www.transportparadise.co.uk/layerswitcher/simplelayerswitcher.js"></script>-->
        <script>
            var app = {
                socketUrl: "{{ SOCKET_URL }}"
            };
            {% if user.is_authenticated %} app.is_authenticated = true; {% endif %}
        </script>

        <script src="{{MEDIA_URL}}/marco-proto/fixtures.js"></script>
        <script src="{{MEDIA_URL}}/marco-proto/map.js"></script>
        <script src="{{MEDIA_URL}}/marco-proto/state.js"></script>
        <script src="{{MEDIA_URL}}/marco-proto/models.js"></script>
        {% if user.is_authenticated and user|in_group:"Designers" %}
            <script src="{{MEDIA_URL}}/marco-proto/scenarios.js"></script>
        {% endif %}
        <script src="{{MEDIA_URL}}/marco-proto/server.js"></script>
        <script src="{{MEDIA_URL}}/marco-proto/printing.js"></script>
        <script src="{{MEDIA_URL}}/marco-proto/app.js"></script>
        <script src="{{MEDIA_URL}}/marco-proto/pageguide.js"></script>
        <script src="{{MEDIA_URL}}/marco-proto/assets/js/jquery.mousewheel.min.js"></script>
        <script src="{{MEDIA_URL}}/marco-proto/assets/js/jquery.mCustomScrollbar.js"></script>


        <script>
        !
        function(d, s, id) {
            var js, fjs = d.getElementsByTagName(s)[0];
            if (!d.getElementById(id)) {
                js = d.createElement(s);
                js.id = id;
                js.src = "//platform.twitter.com/widgets.js";
                fjs.parentNode.insertBefore(js, fjs);
            }
        }(document, "script", "twitter-wjs");
        </script>
    </body>

</html>